# lung_prediction
# 因数据集涉及到隐私,如需要请联系wanggang userbean@outlook.com

原数据集是380GB，包含2704个病人的CT影像，csv数据中具有：
身高,体重,性别,年龄,吸烟史
FEV1,FVC,FEV1/FVC,FEV1%,FVC%

本实例使用3DCNN实现CT影像结合统计学数据，预测肺功能指标并对COPD慢性阻塞肺病进行分类和预测。

本实例使用了3种3DCNN的骨干网络构建了15种模型：

### 回归模型
- 模型使用CT和CSV数据（身高、体重、性别、年龄、吸烟史）作为输入，通过回归头输出
- 以此预测FEV1、FVC、FEV1/FVC、FEV1%、FVC%
- 通过全球肺功能指南金标准，对病人进行分类：
  - 3分类任务：COPD，NORMAL，PRISm
  - 2分类任务：COPD，NORMAL

### 2分类模型、3分类模型
- 模型使用CT和CSV数据（身高、体重、性别、年龄、吸烟史）作为输入
- 用分类头直接预测，对病人进行分类：
  - 3分类任务：COPD，NORMAL，PRISm
  - 2分类任务：COPD，NORMAL

### 2分类多任务学习模型、3分类多任务学习模型
- 模型使用CT和CSV数据（身高、体重、性别、年龄、吸烟史）作为输入
- 通过回归头输出的数值与融合层的向量进行拼接
- 再通过分类头对病人进行分类：
  - 3分类任务：COPD，NORMAL，PRISm
  - 2分类任务：COPD，NORMAL

每种模型用3种不同的骨干网络，总共15个模型，用于消融实验和对比。
<img width="2086" height="942" alt="image" src="https://github.com/user-attachments/assets/fd99abb1-3652-44fc-9aff-399309ee3a02" />
<img width="1810" height="1062" alt="image" src="https://github.com/user-attachments/assets/ec503e10-70a0-459e-9a6e-c0b5de78917e" />
<img width="1824" height="1224" alt="image" src="https://github.com/user-attachments/assets/e6849423-417e-472c-bcd9-50f6d810a1f0" />
<img width="1000" height="800" alt="test_roc_curve" src="https://github.com/user-attachments/assets/c513bd16-38c6-4ceb-9efa-91e91941e7b2" />
<img width="1000" height="800" alt="test_roc_curve (1)" src="https://github.com/user-attachments/assets/dfcd8b03-b59a-4428-8d1b-f453594d54b8" />


所有的模型都是基于以下架构，无非是最后是回归头或者分类头。
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 输入层 (Inputs)                                  │
│  ┌───────────────────────┐                        ┌───────────────────────────┐  │
│  │   3D图像输入          │                        │   CSV特征输入             │  │
│  │ (B, C_img, D, H, W)   │                        │ (B, C_csv=10)             │  │
│  └───────────────────────┘                        └───────────────────────────┘  │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          图像特征提取网络 (Image Feature Network)                │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  选择分支 (根据 image_network_name):                                   │   │
│  │                                                                         │   │
│  │  1. ResNet分支:                                                        │   │
│  │     ResNetFeatures (resnet18, 3D) → 最后一层特征图 → (B, 512, D, H, W) │   │
│  │     (支持加载预训练权重: ./model/resnet_18_23dataset.pth)              │   │
│  │                                                                         │   │
│  │  2. DenseNet分支:                                                      │   │
│  │     DenseNet121 (3D) → features层 → (B, 1024, D, H, W)                  │   │
│  │                                                                         │   │
│  │  3. SeResNet分支:                                                      │   │
│  │     SEResNet50 (3D) → features层 → (B, 2048, D, H, W)                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  全局平均池化 (Adaptive Avg Pool3d) → (B, F_img, 1, 1, 1)                     │
│  展平 (Flatten) → (B, F_img)  [F_img: 512/1024/2048, 对应上述分支]             │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        CSV特征处理与门控融合 (CSV Gating Fusion)                 │
│                                                                                 │
│  ┌────────────────────────────────┐     ┌────────────────────────────────────┐ │
│  │ CSV升维MLP:                    │     │ 门控网络 (Gating):                 │ │
│  │ Linear(10, F_img)              │     │ Linear(F_img, F_img)              │ │
│  │ BatchNorm1d(F_img)             │     │ Sigmoid() → 门控系数 (B, F_img)    │ │
│  │ ReLU() → CSV嵌入 (B, F_img)    │     └───────────┬────────────────────────┘ │
│  └──────────────────┬─────────────┘                 │                          │
│                     │                               │                          │
│                     ▼                               ▼                          │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │ 元素乘法 (Element-wise Mul): CSV嵌入 × 门控系数 → 加权CSV特征 (B, F_img)    │    │
│  └───────────────────────────────────┬────────────────────────────────────┘    │
│                                      │                                           │
│  ┌───────────────────────────────────┼────────────────────────────────────┐    │
│  │ 特征融合 (Add): 图像特征 + 加权CSV特征 → 组合特征 (B, F_img)              │    │
│  └───────────────────────────────────┬────────────────────────────────────┘    │
└──────────────────────────────────────┼─────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          融合特征处理层 (Fusion Layer)                           │
│                                                                                 │
│  Sequential:                                                                    │
│  Linear(F_img, 512) → BatchNorm1d(512) → ReLU() → Dropout(0.5)                  │
│  Linear(512, 256) → BatchNorm1d(256) → ReLU() → Dropout(0.5)                    │
│  → 融合后特征 (B, 256)                                                          │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                  ┌─────────────────┴─────────────────┐
                  │                                   │
                  ▼                                   ▼
┌─────────────────────────────┐     ┌─────────────────────────────────────────────┐
│       回归头 (Regression Head)    │     │       分类头 (Classification Head)        │
│                                  │     │                                           │
│  分支1: num_targets > 1          │     │  输入拼接: 融合后特征 (256) + 回归输出 (T) │
│  ModuleList([Linear(256,1) × T]) │     │  → (B, 256 + T) [T: num_targets/1]       │
│  输出拼接 → (B, T)               │     │                                           │
│                                  │     │  Sequential:                              │
│  分支2: num_targets = 1          │     │  Linear(256+T, 128) → BatchNorm1d(128)   │
│  Linear(256, 1) → (B, 1)         │     │  ReLU() → Dropout(0.5)                   │
│                                  │     │  Linear(128, num_classes) → (B, C)       │
│  回归输出: (B, T) [T=num_targets] │     │  分类输出: (B, C) [C=num_classes]        │
└─────────────────────────────────┘     └─────────────────────────────────────────┘
```
